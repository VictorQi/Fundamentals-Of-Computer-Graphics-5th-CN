# 7. 变换矩阵

线性代数的机制可以用来表达在3D场景中排列对象、用摄像机观察它们并将它们显示到屏幕上所需的许多操作。几何变换，如旋转、平移、缩放和投影，都可以通过矩阵乘法来实现，而用于执行这些操作的变换矩阵正是本章的主题。
我们将展示当点被表示为从原点出发的偏移向量时，点集是如何变换的，我们将使用图7.1中显示的时钟作为点集的例子。因此，可以将时钟想象为一堆点，这些点是向量的端点，而这些向量的起点都在原点。我们还讨论这些变换如何对位置（点）、位移向量和表面法向量产生不同的作用。

## 7.1 二维线性变换

我们可以使用一个$2 \times 2$矩阵来改变或变换一个2D向量：

$$\begin{bmatrix}
a_{11} & a_{12} \\
a_{21} & a_{22}
\end{bmatrix}
\begin{bmatrix}
x \\
y
\end{bmatrix} = \begin{bmatrix}
a_{11}x + a_{12}y \\
a_{21}x + a_{22}y
\end{bmatrix}$$

这种操作接收一个二维向量并通过简单的矩阵乘法产生另一个二维向量，这是一个**线性变换**。

通过这个简单的公式，我们可以实现各种有用的变换，这取决于我们在矩阵的元素中放入什么值，这将在以下章节中讨论。对于我们的目的，考虑沿x轴的移动为水平移动，沿y轴的移动为垂直移动。

### 7.1.1 缩放

最基本的变换是沿坐标轴的缩放变换。这种变换可以改变长度，也可能改变方向：
在计算机图形学中，缩放变换是最基础的几何变换之一。沿坐标轴的缩放变换通过缩放矩阵来实现，其数学表达式为：

最基本的变换是沿坐标轴的缩放变换。这种变换可以改变长度，也可能改变方向：

在计算机图形学中，缩放变换是最基础的几何变换之一。沿坐标轴的缩放变换通过缩放矩阵来实现，其数学表达式为：

$$scale(s_{x}, s_{y}) = \begin{bmatrix}
s_x & 0 \\
0 & s_y
\end{bmatrix}$$

注意这个矩阵对具有笛卡尔分量 $(x, y)$ 的向量所产生的作用：

$$\begin{bmatrix}
s_x & 0 \\
0 & s_y
\end{bmatrix} \begin{bmatrix}
x \\
y
\end{bmatrix} = \begin{bmatrix}
s_x x \\
s_y y
\end{bmatrix}$$

因此，仅仅通过观察轴对齐缩放的矩阵，我们就能读出两个缩放因子。

### 7.1.2 切变

切变是一种将物体横向推移的变换，产生的效果类似于用手推一叠纸牌；底部的纸牌保持不动，而越靠近顶部的纸牌移动得越多。水平和垂直切变矩阵为

$$shear-x(s) = \begin{bmatrix}
1 & s \\
0 & 1
\end{bmatrix}, shear-y(s) = \begin{bmatrix}
1 & 0 \\
s & 1
\end{bmatrix}$$

### 7.1.3 旋转

假设我们想要将向量**a**逆时针旋转角度**φ**以得到向量**b**（图7.5）。如果**a**与x轴的夹角为**α**，且其长度为$r = \sqrt{x_a^2 + y_a^2}$，那么我们知道：

$$x_a = r \cos α$$
$$y_a = r \sin α$$

因为**b**是**a**的旋转结果，所以它也具有长度**r**。由于它相对于**a**旋转了角度**φ**，所以**b**与x轴的夹角为**(α + φ)**。使用三角恒等式（第2.3.3节）：

$$\cos(α + φ) = \cos α \cos φ - \sin α \sin φ$$
$$\sin(α + φ) = \sin α \cos φ + \cos α \sin φ$$

我们可以得到：

$$x_b = r \cos(α + φ) = r(\cos α \cos φ - \sin α \sin φ)$$
$$y_b = r \sin(α + φ) = r(\sin α \cos φ + \cos α \sin φ)$$

由于$x_a = r \cos α$和$y_a = r \sin α$，我们可以将上式重写为：

$$x_b = x_a \cos φ - y_a \sin φ$$
$$y_b = x_a \sin φ + y_a \cos φ$$

这就给出了二维旋转变换的基本公式：

$$rotate(φ) = \begin{bmatrix}
\cos φ & -\sin φ \\
\sin φ & \cos φ
\end{bmatrix}$$

### 7.1.4 反射

我们可以通过使用带有一个负缩放因子的缩放变换来实现向量在坐标轴上的反射（见图7.8和图7.9）：

**沿y轴反射**（即相对于y轴镜像）：
$$\text{reflect-y} = \begin{pmatrix} -1 & 0 \\ 0 & 1 \end{pmatrix}$$

**沿x轴反射**（即相对于x轴镜像）：
$$\text{reflect-x} = \begin{pmatrix} 1 & 0 \\ 0 & -1 \end{pmatrix}$$

这些反射变换的工作原理：

1. **沿y轴反射**：将x坐标取负值，y坐标保持不变
   - $(x, y) \rightarrow (-x, y)$

2. **沿x轴反射**：将y坐标取负值，x坐标保持不变
   - $(x, y) \rightarrow (x, -y)$

需要注意的是，反射变换实际上是一种特殊的缩放变换，其中一个轴的缩放因子为-1。这种变换会改变坐标系的手性（从右手系变为左手系，或反之）。

虽然人们可能会认为对角线上两个元素都为-1的矩阵也是反射变换，但实际上它只是一个旋转**π弧度**（即180°）的旋转变换。

$$\begin{pmatrix} -1 & 0 \\ 0 & -1 \end{pmatrix}$$

我们可以通过旋转矩阵来验证这一点：

$$\mathbf{R}(π) = \begin{pmatrix} \cos π & -\sin π \\ \sin π & \cos π \end{pmatrix} = \begin{pmatrix} -1 & 0 \\ 0 & -1 \end{pmatrix}$$

这个变换将点$(x, y)$映射为$(-x, -y)$，这相当于绕原点旋转180°，而不是反射。

**关键区别**：
- **反射变换**会改变坐标系的手性（行列式为-1）
- **旋转变换**保持坐标系的手性（行列式为+1）

对于上述矩阵：
$$\det\begin{pmatrix} -1 & 0 \\ 0 & -1 \end{pmatrix} = (-1) \times (-1) = 1$$

行列式为正，说明这是一个保持定向的变换（旋转），而不是改变定向的变换（反射）。

### 7.1.5 变换的组合

在图形程序中，通常需要对一个对象应用多个变换。例如，我们可能希望先应用缩放变换$S$，然后应用旋转变换$R$。对于二维向量$\vec{v_1}$，这需要分两步进行：

首先，$\mathbf{v_2} = \mathbf{S}\vec{v_1}$，然后，$\mathbf{v_3} = \mathbf{R}\vec{v_2}$。

另一种表示方法是：
$$\vec{v_3} = \mathbf{R}(\mathbf{S}\vec{v_1})$$

由于矩阵乘法具有结合律，我们也可以写成：
$$\vec{v_3} = (\mathbf{R}\mathbf{S})\vec{v_1}$$

换句话说，我们可以用一个相同尺寸的单一矩阵来表示对向量依次应用两个矩阵变换的效果，这个矩阵可以通过将两个矩阵相乘得到：$\mathbf{M} = \mathbf{R}\mathbf{S}$（图7.10）。

![Figure7.10](/pic/Figure7-10.png)

**非常重要的一点是要记住，这些变换是从右侧开始依次应用的。因此矩阵 $M = RS$ 首先应用 $S$，然后应用 $R$。**

这个顺序规则来源于矩阵乘法的性质：当我们写 $RS\vec{v}$ 时，根据结合律，这等价于 $R(S\vec{v})$，意味着先对向量 $\vec{v}$ 应用变换 $S$，再对结果应用变换 $R$。

### 7.1.6 变换的分解

有时候，需要"撤销"变换的组合，将一个变换分解为更简单的部分。例如，通常需要向用户呈现一个变换以便操作，这时最好将其表示为独立的旋转和缩放因子，但变换在内部可能只是简单地表示为一个矩阵，其中旋转和缩放已经混合在一起。如果矩阵可以通过计算分解为所需的部分，调整这些部分，然后通过将部分重新相乘来重新组装矩阵，那么就可以实现这种操作。

事实证明，无论矩阵中的条目如何，这种分解或因式分解都是可能的——这一事实为思考变换及其对被变换几何体的作用提供了一种富有成效的方式。

#### 对称特征值分解

让我们从对称矩阵开始。回顾第6.4节，对称矩阵总是可以使用特征值分解拆分为以下形式的乘积：

$$\mathbf{A} = \mathbf{R}\mathbf{S}\mathbf{R}^T$$

其中$\mathbf{R}$是正交矩阵，$\mathbf{S}$是对角矩阵；我们将$\mathbf{R}$的列（特征向量）称为$\vec{v_1}$和$\vec{v_2}$，将$\mathbf{S}$的对角元素（特征值）称为$\lambda_1$和$\lambda_2$。

从几何角度来看，我们现在可以将$\mathbf{R}$识别为旋转变换，将$\mathbf{S}$识别为缩放变换，因此这只是一个多步骤的几何变换（图7.12）：

![Figure7.12](/pic/Figure7-12.png)

1. 将$\vec{v_1}$和$\vec{v_2}$旋转到$x$轴和$y$轴（通过$\mathbf{R}^T$变换）
2. 在$x$和$y$方向上分别缩放$(\lambda_1, \lambda_2)$（通过$\mathbf{S}$变换）
3. 将$x$轴和$y$轴旋转回$\vec{v_1}$和$\vec{v_2}$（通过$\mathbf{R}$变换）

观察这三个变换的综合效果，我们可以看到它们的作用等同于沿一对轴进行非均匀缩放。与轴对齐缩放一样，这些轴是垂直的，但它们不是坐标轴；相反，它们是$\mathbf{A}$的特征向量。这告诉我们对称矩阵意味着什么：**对称矩阵仅仅是缩放操作——尽管可能是非均匀的和非轴对齐的缩放**。

#### 奇异值分解

对于非对称矩阵，也可以进行非常相似的分解：这就是奇异值分解（SVD），在第6.4.1节中也有讨论。不同之处在于对角矩阵两侧的矩阵不再相同：

$$\mathbf{A} = \mathbf{U}\mathbf{S}\mathbf{V}^T$$

替代单一旋转$\mathbf{R}$的两个正交矩阵称为$\mathbf{U}$和$\mathbf{V}$，它们的列分别称为$\vec{u_i}$（左奇异向量）和$\vec{v_i}$（右奇异向量）。在这种情况下，$\mathbf{S}$的对角元素称为奇异值而不是特征值。几何解释与对称特征值分解非常相似（图7.14）：

![Figure7.14](/pic/Figure7-14.png)

1. 将$\vec{v_1}$和$\vec{v_2}$旋转到$x$轴和$y$轴（通过$\mathbf{V}^T$变换）
2. 在$x$和$y$方向上分别缩放$(\sigma_1, \sigma_2)$（通过$\mathbf{S}$变换）
3. 将$x$轴和$y$轴旋转到$\vec{u_1}$和$\vec{u_2}$（通过$\mathbf{U}$变换）

主要区别在于用两个不同的正交矩阵代替了单一旋转。这种差异导致了另一个不太重要的区别。由于SVD在两侧具有不同的奇异向量，因此不需要负奇异值：我们总是可以翻转奇异值的符号，反转相关奇异向量之一的方向，最终得到相同的变换。因此，SVD总是产生一个对角线元素全为正的对角矩阵，但矩阵$\mathbf{U}$和$\mathbf{V}$不能保证是旋转——它们也可能包含反射。

在图形学等几何应用中，这是一个不便，但是是一个小问题：通过检查行列式很容易区分旋转和反射，旋转的行列式为$+1$，反射的行列式为$-1$。如果需要旋转，可以将其中一个奇异值取负，从而得到旋转-缩放-旋转序列，其中反射与缩放结合，而不是与其中一个旋转结合。

#### Paeth旋转分解

另一种分解使用切变来表示非零旋转(Paeth, 1990)。以下恒等式使这成为可能：

$$\begin{bmatrix} \cos\theta & -\sin\theta \\ \sin\theta & \cos\theta \end{bmatrix} = \begin{bmatrix} 1 & \frac{\cos\theta - 1}{\sin\theta} \\ 0 & 1 \end{bmatrix} \begin{bmatrix} 1 & 0 \\ \sin\theta & 1 \end{bmatrix} \begin{bmatrix} 1 & \frac{\cos\theta - 1}{\sin\theta} \\ 0 & 1 \end{bmatrix}$$

![Figure7.16](/pic/Figure7-16.png)

这种特殊的变换对栅格旋转很有用，因为剪切对图像来说是一种非常高效的栅格操作；它会引入一些锯齿，但不会留下空洞。关键观察是，如果我们取一个栅格位置$(i, j)$并对其应用水平剪切，我们得到：

$$\begin{bmatrix}
1 & s \\
0 & 1
\end{bmatrix} \begin{bmatrix}
i \\
j
\end{bmatrix} = \begin{bmatrix}
i + sj \\
j
\end{bmatrix}$$

如果我们将$sj$舍入到最近的整数，这相当于取图像中的每一行并将其横向移动某个量——每一行的移动量都不同。因为在一行内位移是相同的，这使我们能够在结果图像中没有间隙的情况下进行旋转。类似的操作对垂直剪切也有效。因此，我们可以轻松实现简单的栅格旋转。

## 7.2 三维线性变换

三维线性变换是二维线性变换的拓展。举个例子，一个沿着笛卡尔坐标轴的缩放变换可以通过以下矩阵来实现：

$$scale(s_x, s_y, s_z) = \begin{bmatrix}
s_x & 0 & 0 \\
0 & s_y & 0 \\
0 & 0 & s_z
\end{bmatrix}$$

三维旋转比二维旋转要复杂得多，因为有更多可能的旋转轴。然而，如果我们只是想绕$z$轴旋转，这只会改变$x$坐标和$y$坐标，我们可以使用二维旋转矩阵，对$z$不进行任何操作：

$$\text{rotate-z}(\phi) = \begin{bmatrix}
\cos\phi & -\sin\phi & 0 \\
\sin\phi & \cos\phi & 0 \\
0 & 0 & 1
\end{bmatrix}$$

同样地，我们可以构造绕$x$轴和$y$轴旋转的矩阵：

$$\text{rotate-x}(\phi) = \begin{bmatrix}
1 & 0 & 0 \\
0 & \cos\phi & -\sin\phi \\
0 & \sin\phi & \cos\phi
\end{bmatrix}$$

$$\text{rotate-y}(\phi) = \begin{bmatrix}
\cos\phi & 0 & \sin\phi \\
0 & 1 & 0 \\
-\sin\phi & 0 & \cos\phi
\end{bmatrix}$$

我们将在下一节中讨论绕任意轴的旋转。

与二维情况一样，我们可以沿特定轴进行切变，例如：

$$\text{shear-x}(d_y, d_z) = \begin{bmatrix}
1 & d_y & d_z \\
0 & 1 & 0 \\
0 & 0 & 1
\end{bmatrix}$$

与二维变换一样，任何三维变换矩阵都可以使用SVD分解为一个旋转、缩放和另一个旋转。任何对称的三维矩阵都有特征值分解，可以分解为旋转、缩放和逆旋转。最后，三维旋转可以分解为三维切变矩阵的乘积。

### 7.2.1 任意三维旋转

与二维情况一样，三维旋转是正交矩阵。从几何角度来说，这意味着矩阵的三行是三个相互正交的单位向量的笛卡尔坐标，如第2.4.5节所讨论的。列也是三个（可能不同的）相互正交的单位向量。这样的旋转矩阵有无穷多个。让我们写出这样一个矩阵：

$$\mathbf{R}_{uvw} = \begin{bmatrix}
x_u & y_u & z_u \\
x_v & y_v & z_v \\
x_w & y_w & z_w
\end{bmatrix}$$

这里，$\mathbf{u} = x_u\mathbf{x} + y_u\mathbf{y} + z_u\mathbf{z}$，对于$\mathbf{v}$和$\mathbf{w}$也是如此。由于这三个向量是标准正交的，我们知道：

$$\mathbf{u} \cdot \mathbf{u} = \mathbf{v} \cdot \mathbf{v} = \mathbf{w} \cdot \mathbf{w} = 1$$

$$\mathbf{u} \cdot \mathbf{v} = \mathbf{v} \cdot \mathbf{w} = \mathbf{w} \cdot \mathbf{u} = 0$$

我们可以通过将旋转矩阵应用于向量$\mathbf{u}$、$\mathbf{v}$和$\mathbf{w}$来推断旋转矩阵的一些行为。例如：

$$\mathbf{R}_{uvw}\mathbf{u} = \begin{bmatrix}
x_u & y_u & z_u \\
x_v & y_v & z_v \\
x_w & y_w & z_w
\end{bmatrix}
\begin{bmatrix}
x_u \\
y_u \\
z_u
\end{bmatrix} = \begin{bmatrix}
x_u x_u + y_u y_u + z_u z_u \\
x_v x_u + y_v y_u + z_v z_u \\
x_w x_u + y_w y_u + z_w z_u
\end{bmatrix}$$

注意$\mathbf{R}_{uvw}\mathbf{u}$的这三行都是点积：

$$\mathbf{R}_{uvw}\mathbf{u} = \begin{bmatrix}
\mathbf{u} \cdot \mathbf{u} \\
\mathbf{v} \cdot \mathbf{u} \\
\mathbf{w} \cdot \mathbf{u}
\end{bmatrix} = \begin{bmatrix}
1 \\
0 \\
0
\end{bmatrix} = \mathbf{x}$$

同样地，$\mathbf{R}_{uvw}\mathbf{v} = \mathbf{y}$，$\mathbf{R}_{uvw}\mathbf{w} = \mathbf{z}$。因此$\mathbf{R}_{uvw}$通过旋转将基底$uvw$转换为相应的笛卡尔坐标轴。

如果$\mathbf{R}_{uvw}$是具有标准正交行的旋转矩阵，那么$\mathbf{R}_{uvw}^T$也是具有标准正交列的旋转矩阵，实际上是$\mathbf{R}_{uvw}$的逆矩阵（正交矩阵的逆矩阵总是其转置矩阵）。一个重要点是，对于变换矩阵，代数逆也是几何逆。因此，如果$\mathbf{R}_{uvw}$将$\mathbf{u}$转换为$\mathbf{x}$，那么$\mathbf{R}_{uvw}^T$将$\mathbf{x}$转换为$\mathbf{u}$。对于$\mathbf{v}$和$\mathbf{y}$也应该如此，我们可以验证：

$$\mathbf{R}_{uvw}^T\mathbf{y} = \begin{bmatrix}
x_u & x_v & x_w \\
y_u & y_v & y_w \\
z_u & z_v & z_w
\end{bmatrix}
\begin{bmatrix} 
0 \\
1 \\
0
\end{bmatrix} = \begin{bmatrix}
x_v \\
y_v \\
z_v
\end{bmatrix} = \mathbf{v}$$

因此，我们总是可以从标准正交基构造旋转矩阵。

如果我们希望绕任意向量$\mathbf{a}$旋转，我们可以形成一个以$\mathbf{w} = \mathbf{a}$为基的标准正交基，将该基旋转到标准基$xyz$，绕z轴旋转，然后将标准基旋转回$uvw$基。在矩阵形式中，绕$\mathbf{w}$轴旋转角度$\phi$：

$$\begin{bmatrix}
x_u & x_v & x_w \\
y_u & y_v & y_w \\
z_u & z_v & z_w
\end{bmatrix}
\begin{bmatrix}
\cos\phi & -\sin\phi & 0 \\
\sin\phi & \cos\phi & 0 \\
0 & 0 & 1
\end{bmatrix}
\begin{bmatrix}
x_u & y_u & z_u \\
x_v & y_v & z_v \\
x_w & y_w & z_w
\end{bmatrix}$$

这里，我们有$\mathbf{w}$是$\mathbf{a}$方向上的单位向量（即$\mathbf{a}$除以其自身长度）。但是$\mathbf{u}$和$\mathbf{v}$是什么呢？第2.4.6节给出了寻找合适的$\mathbf{u}$和$\mathbf{v}$的方法。

如果我们有一个旋转矩阵，并且希望将旋转表示为轴-角形式，我们可以计算其唯一的实特征值（为$\lambda = 1$），相应的特征向量就是旋转轴。这是唯一不被旋转改变的轴。

参见第16章，了解除旋转矩阵外几种最常用的旋转表示方法的比较。

### 7.2.2 法向量的变换

虽然我们使用的大多数三维向量表示位置（从原点出发的偏移向量）或方向（例如光的来源方向），但有些向量表示表面法线。表面法向量垂直于表面的切平面。当底层表面发生变换时，这些法线不会按我们期望的方式进行变换。例如，如果表面的点通过矩阵$\mathbf{M}$进行变换，与表面相切且乘以$\mathbf{M}$的向量$\mathbf{t}$将与变换后的表面相切。然而，通过$\mathbf{M}$变换的表面法向量$\mathbf{n}$可能不再垂直于变换后的表面（图6.17）。

我们可以推导出一个变换矩阵$\mathbf{N}$，它能将$\mathbf{n}$转换为垂直于变换后表面的向量。解决这个问题的一种方法是注意到表面法向量和切向量是垂直的，所以它们的点积为零，这可以用矩阵形式表示为：

$$\mathbf{n}^T\mathbf{t} = 0$$
